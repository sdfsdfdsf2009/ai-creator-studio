# 更新日志

所有重要项目的变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/en/1.0.0/) 规则。

## [1.1.0] - 2025-10-27

### 🚀 重大架构更新 - 能力系统
- **完整的能力系统架构**: 实现模块化的能力系统，将复杂功能封装为独立、可重用的能力组件
- **7个核心能力模块**:
  - `VideoGenerationCapability`: 视频生成能力，支持同步/异步生成和轮询管理
  - `ImageGenerationCapability`: 图像生成能力，支持多模型对比和批量生成
  - `TaskManagementCapability`: 任务管理能力，提供完整的任务CRUD和状态管理
  - `AsyncProcessingCapability`: 异步处理能力，统一的超时和重试机制
  - `BatchProcessingCapability`: 批量处理能力，支持CSV处理和变量映射
  - `AssetManagementCapability`: 资产管理能力，集成素材库和文件管理
  - `ExternalIntegrationCapability`: 外部集成能力，支持飞书、webhook等集成
- **能力组合器**: `CapabilityComposer` 提供高级工作流编排，支持多能力协同工作
- **统一接口设计**: 所有能力都实现相同的 `BaseCapability` 接口，确保一致性
- **依赖注入架构**: 通过工厂模式和依赖注入实现松耦合设计

### 🔧 技术架构升级
- **循环依赖问题解决**: 重构导入导出结构，解决能力系统循环依赖问题
- **动态导入优化**: 使用动态导入避免编译时依赖问题
- **错误处理统一**: 实现统一的错误处理、重试机制和降级策略
- **性能优化**: 连接池管理、缓存策略和资源优化
- **监控系统**: 内置健康检查和性能监控能力

### 📚 API和工具增强
- **新API端点**: `/api/tasks-new/` 基于能力系统的完整API实现
- **简化API**: `/api/tasks-simple/` 功能完整的简化版API
- **能力系统文档**: 完整的使用指南和开发文档
- **模型名称映射**: 统一的模型名称映射工具
- **批量处理工具**: 增强的CSV导入和批量任务处理

### 🐛 关键问题修复
- **任务状态逻辑修复**: 解决视频任务状态不一致问题，确保只有轮询成功后才标记为完成
- **重试机制优化**: 修复模型名称映射错误，避免重试循环
- **轮询API增强**: 修复轮询字段映射问题，支持 `external_task_id` 字段
- **数据库迁移完善**: 添加缺失的数据库字段和迁移脚本
- **编译缓存清理**: 解决多进程并发导致的缓存冲突问题

### 💎 用户体验改进
- **更好的错误提示**: 统一的错误消息格式和本地化支持
- **增强的任务管理**: 更准确的任务状态和进度显示
- **简化的开发体验**: 通过能力组合器快速构建复杂功能
- **更强的扩展性**: 模块化设计支持快速功能扩展

### 🔍 开发者体验提升
- **完整的类型支持**: TypeScript类型定义和智能提示
- **便捷的能力函数**: `useVideoGeneration()`, `useImageGeneration()` 等
- **统一的配置管理**: 集中化的能力配置和环境适配
- **详细的使用示例**: 完整的代码示例和最佳实践

### 📊 系统稳定性提升
- **内存使用优化**: 改进的资源管理和内存泄漏防护
- **并发控制**: 优化的并发处理和队列管理
- **监控和日志**: 完善的日志系统和健康检查
- **容错机制**: 多层次的错误恢复和降级策略

### ⚠️ 重要说明
- **BREAKING CHANGE**: 核心架构重构，推荐使用新的能力系统API
- **向后兼容**: 保持现有API的向后兼容性
- **迁移指南**: 提供详细的迁移文档和工具

## [1.0.1] - 2025-10-24

### 🎯 主要功能改进
- **Prompt长度限制优化**: 将限制从1000字符提升到2000字符，支持用户输入更详细的创意描述
- **智能截断机制**: 当Prompt超过2000字符时，自动保留前90%内容并添加省略号，避免完全失败
- **前端UI增强**: 添加实时字符计数显示和超长警告提示
- **错误处理升级**: 实现智能重试机制和优雅降级处理

### 🐛 问题修复
- 修复了批量任务中Prompt长度超过1000字符导致执行失败的问题
- 解决了模型去重算法错误，确保正确计算任务数量
- 修复了批量任务执行时的错误处理逻辑
- 解决了`processedPrompt is not defined`的运行时错误

### 💎 用户体验改进
- **实时字符反馈**: 在Variable Editor组件中显示 `xxx/2000 字符` 的实时计数
- **视觉警告提示**: 当Prompt超过限制时，输入框显示红色边框和警告信息
- **智能错误恢复**: 系统自动尝试截断过长的Prompt而不是直接报错
- **增强稳定性**: 批量任务成功率和完成率显著提升

### 🔧 技术更新
- **Backend**:
  - `src/lib/ai-providers/proxy.ts`: 增加Prompt长度验证和智能截断
  - `src/lib/batch-processor.ts`: 增强错误处理和重试机制
- **Frontend**:
  - `src/components/variable-editor.tsx`: 添加实时字符计数和UI警告
- **Configuration**:
  - `package.json`: 版本号更新到1.0.1
  - `.gitignore`: 增加临时文件过滤规则

### 🧪 测试验证
- ✅ 1238字符长度的Prompt成功接受并执行
- ✅ 2000字符限制验证正常工作
- ✅ 智能截断功能正常运作
- ✅ 实时字符计数准确显示
- ✅ 错误处理和重试机制有效

### 📚 文档更新
- 更新了内部开发文档和测试流程
- 创建了详细的变更记录和修复说明

---

## [0.1.0] - 2025-10-22

### 🎯 初始功能实现
- 实现了基础的多模型批量任务功能
- 完成了变量系统和任务自动执行
- 建立了完整的数据库结构和API接口
- 实现了基础的UI界面和用户交互

### 💎 核心特性
- 多模型批量创建和执行
- 变量替换和组合生成
- 任务管理和状态跟踪
- 材料库集成和结果存储

### 🏗️ 系统架构
- Next.js 13.5.6 + TypeScript
- SQLite数据库集成
- 国际化支持 (中英文)
- Tailwind CSS样式系统

---

## 版本说明

- **Major版本**: 重大功能更新或不兼容的API变更
- **Minor版本**: 新功能添加或向后兼容的API变更
- **Patch版本**: 问题修复或小幅改进