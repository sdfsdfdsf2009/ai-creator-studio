'use client'

import React, { useState, useEffect } from 'react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Badge } from '@/components/ui/badge'
import { VariableEditor } from '@/components/variable-editor'
import { Task, MediaType, Variable } from '@/types'
import { proxyAccountManager } from '@/lib/client-proxy-account-manager'
import { modelConfigManager } from '@/lib/client-model-config-manager'
import { proxyProviderManager } from '@/lib/ai-providers/proxy'

interface TaskFormProps {
  onSubmit: (taskData: {
    type: MediaType
    prompt: string
    model: string
    parameters: Record<string, any>
  }) => void
  onCancel?: () => void
  initialData?: Partial<Task>
}

// AI Ê®°ÂûãÈÖçÁΩÆ
const AI_MODELS = {
  image: [
    { id: 'dall-e-3', name: 'DALL-E 3', provider: 'OpenAI', cost: 0.04 },
    { id: 'dall-e-2', name: 'DALL-E 2', provider: 'OpenAI', cost: 0.02 },
    { id: 'midjourney-v6', name: 'MidJourney v6', provider: 'MidJourney', cost: 0.03 },
    { id: 'midjourney-v5.2', name: 'MidJourney v5.2', provider: 'MidJourney', cost: 0.025 },
    { id: 'stable-diffusion-xl', name: 'Stable Diffusion XL', provider: 'Stability AI', cost: 0.01 },
    { id: 'stable-diffusion-3', name: 'Stable Diffusion 3', provider: 'Stability AI', cost: 0.04 },
    { id: 'stable-diffusion-2.1', name: 'Stable Diffusion 2.1', provider: 'Stability AI', cost: 0.008 },
    { id: 'flux-pro', name: 'Flux Pro', provider: 'Flux', cost: 0.03 },
    { id: 'flux-schnell', name: 'Flux Schnell', provider: 'Flux', cost: 0.008 },
    { id: 'flux-dev', name: 'Flux Dev', provider: 'Flux', cost: 0.015 },
    { id: 'sdxl-turbo', name: 'SDXL Turbo', provider: 'Stability AI', cost: 0.004 },
    { id: 'gemini-2.5-flash-image', name: 'Gemini 2.5 Flash (Nano Banana)', provider: 'Nano Banana', cost: 1.6 },
    { id: 'gemini-2.0-pro-image', name: 'Gemini 2.0 Pro (Nano Banana)', provider: 'Nano Banana', cost: 2.4 },
    { id: 'ideogram-2.0', name: 'Ideogram 2.0', provider: 'Ideogram', cost: 0.05 },
    { id: 'kandinsky-3.0', name: 'Kandinsky 3.0', provider: 'Sber', cost: 0.01 },
  ],
  video: [
    { id: 'runway-gen3', name: 'Runway Gen-3', provider: 'Runway', cost: 0.25 },
    { id: 'runway-gen2', name: 'Runway Gen-2', provider: 'Runway', cost: 0.15 },
    { id: 'runway-gen3-turbo', name: 'Runway Gen-3 Turbo', provider: 'Runway', cost: 0.20 },
    { id: 'pika-labs', name: 'Pika Labs', provider: 'Pika', cost: 0.12 },
    { id: 'pika-1.5', name: 'Pika 1.5', provider: 'Pika', cost: 0.15 },
    { id: 'stable-video', name: 'Stable Video Diffusion', provider: 'Stability AI', cost: 0.08 },
    { id: 'stable-video-xt', name: 'Stable Video XT', provider: 'Stability AI', cost: 0.10 },
    { id: 'luma-dream-machine', name: 'Luma Dream Machine', provider: 'Luma', cost: 0.12 },
    { id: 'kling-v1', name: 'Kling v1', provider: 'Kling', cost: 0.08 },
    { id: 'sora-1.0', name: 'Sora 1.0', provider: 'OpenAI', cost: 0.50 },
  ]
}

export function TaskForm({ onSubmit, onCancel, initialData }: TaskFormProps) {
  const [taskType, setTaskType] = useState<MediaType>(initialData?.type || 'image')
  const [prompt, setPrompt] = useState(initialData?.prompt || '')
  const [selectedModel, setSelectedModel] = useState(initialData?.model || '')
  const [selectedAccountId, setSelectedAccountId] = useState<string | null>(null)
  const [parameters, setParameters] = useState<Record<string, any>>(initialData?.parameters || {})
  const [estimatedCost, setEstimatedCost] = useState(0)
  const [variables, setVariables] = useState<Record<string, Variable>>({})
  const [variableValues, setVariableValues] = useState<Record<string, any>>({})
  const [availableAccounts, setAvailableAccounts] = useState<any[]>([])
  const [availableModels, setAvailableModels] = useState<ModelInfo[]>([])
  const [configuredModels, setConfiguredModels] = useState<any[]>([])
  const [loadingModels, setLoadingModels] = useState(true)

  // Âä†ËΩΩÂèØÁî®Ê®°ÂûãÂíåË¥¶Âè∑
  useEffect(() => {
    const loadData = async () => {
      try {
        setLoadingModels(true)

        // Âä†ËΩΩÂèØÁî®ÁöÑ‰ª£ÁêÜË¥¶Âè∑
        const accounts = await proxyAccountManager.getAccounts()
        const enabledAccounts = accounts.filter(account => account.enabled)
        setAvailableAccounts(enabledAccounts)

        // Âä†ËΩΩÂ∑≤ÈÖçÁΩÆÁöÑÊ®°Âûã
        const configs = await modelConfigManager.getConfigs({ enabled: true })
        setConfiguredModels(Array.isArray(configs) ? configs : [])

        // Ëé∑ÂèñÊâÄÊúâÂèØËÉΩÁöÑÊ®°ÂûãÔºàÂåÖÂê´EvoLinkÊ®°ÂûãÔºâ
        const allModels = await modelConfigManager.getAllAvailableModels()
        setAvailableModels(allModels)

        // Â¶ÇÊûúÊúâÂàùÂßãÊï∞ÊçÆ‰∏≠ÁöÑÊ®°ÂûãÔºåÊ£ÄÊü•ÊòØÂê¶ËøòÂèØÁî®
        if (initialData?.model) {
          const isModelConfigured = Array.isArray(configs) && configs.some(c => c.modelName === initialData.model)
          if (!isModelConfigured) {
            console.warn(`Model ${initialData.model} is not configured`)
            setSelectedModel('')
          }
        }

        // Ëá™Âä®ÈÄâÊã©Á¨¨‰∏Ä‰∏™ÂèØÁî®ÁöÑË¥¶Âè∑
        if (enabledAccounts.length > 0 && !selectedAccountId) {
          setSelectedAccountId(enabledAccounts[0].id)
        }
      } catch (error) {
        console.error('Failed to load data:', error)
      } finally {
        setLoadingModels(false)
      }
    }

    loadData()
  }, [initialData?.model, selectedAccountId])

  // ÂΩìÈÄâ‰∏≠ÁöÑË¥¶Âè∑ÊîπÂèòÊó∂ÔºåÈáçÁΩÆÊ®°ÂûãÈÄâÊã©
  useEffect(() => {
    if (selectedAccountId) {
      setSelectedModel('') // ÈáçÁΩÆÊ®°ÂûãÈÄâÊã©
    }
  }, [selectedAccountId])

  // ÂΩì‰ªªÂä°Á±ªÂûãÊîπÂèòÊó∂ÔºåÈáçÁΩÆÈÄâ‰∏≠ÁöÑÊ®°ÂûãÔºàÂ¶ÇÊûúÂΩìÂâçÊ®°Âûã‰∏çÊîØÊåÅÊñ∞ÁöÑ‰ªªÂä°Á±ªÂûãÔºâ
  useEffect(() => {
    if (selectedModel) {
      const model = availableModels.find(m => m.id === selectedModel)
      if (model && model.mediaType !== taskType) {
        setSelectedModel('')
      }
    }
  }, [taskType, selectedModel, availableModels])

  // ËÆ°ÁÆóÈ¢Ñ‰º∞ÊàêÊú¨
  const calculateCost = () => {
    // ‰ºòÂÖà‰ΩøÁî®Âä®ÊÄÅÊ®°Âûã‰ø°ÊÅØ
    const model = availableModels.find(m => m.id === selectedModel)

    // Â¶ÇÊûúÂä®ÊÄÅÊ®°Âûã‰∏≠Ê≤°ÊúâÊâæÂà∞ÔºåÂõûÈÄÄÂà∞Á°¨ÁºñÁ†ÅÁöÑÊ®°ÂûãÂàóË°®
    let fallbackCost = 0
    if (!model) {
      const hardcodedModels = AI_MODELS[taskType]
      const hardcodedModel = hardcodedModels.find(m => m.id === selectedModel)
      fallbackCost = hardcodedModel?.cost || 0
    }

    const baseCost = model?.cost || fallbackCost || 0
    let multiplier = 1

    if (taskType === 'image') {
      multiplier = parameters.quantity || 1
    } else if (taskType === 'video') {
      multiplier = parameters.duration || 5 // ÈªòËÆ§5Áßí
    }

    return baseCost * multiplier
  }

  // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠Ë¥¶Âè∑Âíå‰ªªÂä°Á±ªÂûãÂèØÁî®ÁöÑÊ®°Âûã
  const getAvailableModelsForType = () => {
    if (!selectedAccountId) {
      return []
    }

    // Á°Æ‰øùconfiguredModelsÊòØÊï∞ÁªÑ
    if (!Array.isArray(configuredModels)) {
      return []
    }

    // 1. Ëé∑ÂèñÂΩìÂâçË¥¶Âè∑ÈÖçÁΩÆÁöÑÊ®°Âûã
    const accountModels = configuredModels.filter(config =>
      config.proxyAccountId === selectedAccountId &&
      config.mediaType === taskType &&
      config.enabled
    )

    // ËΩ¨Êç¢Â∑≤ÈÖçÁΩÆÊ®°Âûã‰∏∫ModelInfoÊ†ºÂºè
    const configuredModelInfos = accountModels.map(config => {
      const baseModel = availableModels.find(m => m.id === config.modelName)
      return {
        id: config.modelName,
        name: baseModel?.name || config.modelName,
        provider: config.proxyProvider || 'unknown',
        supportedProviders: baseModel?.supportedProviders || [],
        mediaType: config.mediaType,
        cost: config.cost || baseModel?.cost || 0,
        isEvoLink: baseModel?.isEvoLink || baseModel?.provider === 'nano-banana' || config.modelName.includes('evolink')
      }
    })

    // 2. Ëé∑ÂèñÊâÄÊúâEvoLinkÊ®°ÂûãÔºà‰∏çÁÆ°ÊòØÂê¶Â∑≤ÈÖçÁΩÆÔºâ
    const evoLinkModels = availableModels.filter(model =>
      model.isEvoLink &&
      model.mediaType === taskType &&
      !configuredModelInfos.some(configured => configured.id === model.id)
    )

    // 3. ÂêàÂπ∂Â∑≤ÈÖçÁΩÆÊ®°ÂûãÂíåEvoLinkÊ®°Âûã
    const allModels = [...configuredModelInfos, ...evoLinkModels]

    // 4. ÊåâÂêçÁß∞ÊéíÂ∫è
    return allModels.sort((a, b) => a.name.localeCompare(b.name))
  }

  // Êåâ‰æõÂ∫îÂïÜÂàÜÁªÑÊ®°Âûã
  const getModelsByProvider = () => {
    const models = getAvailableModelsForType()
    const grouped: Record<string, typeof models> = {}

    models.forEach(model => {
      let provider = model.provider

      // ÁâπÊÆäÂ§ÑÁêÜEVoLink.AIÊ®°Âûã
      if (model.isEvoLink || provider === 'nano-banana') {
        provider = 'EVoLink.AI'
      }

      if (!grouped[provider]) {
        grouped[provider] = []
      }
      grouped[provider].push(model)
    })

    return grouped
  }

  // Ëé∑Âèñ‰æõÂ∫îÂïÜÁöÑÊòæÁ§∫ÂêçÁß∞ÂíåÊ†∑Âºè
  const getProviderInfo = (provider: string) => {
    const providerMap: Record<string, { name: string; color: string; icon: string }> = {
      'EVoLink.AI': { name: 'EVoLink.AI', color: 'text-purple-600', icon: 'üîó' },
      'openai': { name: 'OpenAI', color: 'text-green-600', icon: 'ü§ñ' },
      'anthropic': { name: 'Anthropic', color: 'text-blue-600', icon: 'üß†' },
      'google': { name: 'Google', color: 'text-red-600', icon: 'üîç' },
      'custom': { name: 'Custom', color: 'text-gray-600', icon: '‚öôÔ∏è' }
    }

    return providerMap[provider] || { name: provider, color: 'text-gray-600', icon: 'üì¶' }
  }

  // Ëé∑ÂèñÊ®°ÂûãÁä∂ÊÄÅ‰ø°ÊÅØ
  const getModelStatus = (modelId: string) => {
    const isConfigured = configuredModels.some(config =>
      config.modelName === modelId && config.enabled
    )

    if (isConfigured) {
      return {
        status: 'configured',
        text: 'Configured',
        color: 'bg-green-500',
        description: 'Configured for this account'
      }
    } else {
      return {
        status: 'unconfigured',
        text: 'Not Configured',
        color: 'bg-gray-500',
        description: 'Not configured for this account'
      }
    }
  }

  // Êõ¥Êñ∞È¢Ñ‰º∞ÊàêÊú¨
  React.useEffect(() => {
    setEstimatedCost(calculateCost())
  }, [taskType, selectedModel, parameters, calculateCost])

  // Ê∏≤ÊüìÂõæÁâáÁîüÊàêÂèÇÊï∞
  const renderImageParameters = () => (
    <div className="space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="space-y-2">
          <Label>Êï∞Èáè</Label>
          <select
            value={parameters.quantity || 1}
            onChange={(e) => setParameters({ ...parameters, quantity: parseInt(e.target.value) })}
            className="w-full px-3 py-2 border rounded-md"
          >
            <option value={1}>1 Âº†</option>
            <option value={2}>2 Âº†</option>
            <option value={4}>4 Âº†</option>
            <option value={8}>8 Âº†</option>
          </select>
        </div>
        
        <div className="space-y-2">
          <Label>Â∞∫ÂØ∏</Label>
          <select
            value={parameters.size || '1024x1024'}
            onChange={(e) => setParameters({ ...parameters, size: e.target.value })}
            className="w-full px-3 py-2 border rounded-md"
          >
            <option value="512x512">512x512</option>
            <option value="1024x1024">1024x1024</option>
            <option value="1024x1792">1024x1792</option>
            <option value="1792x1024">1792x1024</option>
          </select>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="space-y-2">
          <Label>Ë¥®Èáè</Label>
          <select
            value={parameters.quality || 'standard'}
            onChange={(e) => setParameters({ ...parameters, quality: e.target.value })}
            className="w-full px-3 py-2 border rounded-md"
          >
            <option value="standard">Ê†áÂáÜ</option>
            <option value="high">È´òË¥®Èáè</option>
          </select>
        </div>
        
        <div className="space-y-2">
          <Label>È£éÊ†º</Label>
          <Input
            value={parameters.style || ''}
            onChange={(e) => setParameters({ ...parameters, style: e.target.value })}
            placeholder="vivid, natural, cinematic..."
          />
        </div>
      </div>
    </div>
  )

  // Ê∏≤ÊüìËßÜÈ¢ëÁîüÊàêÂèÇÊï∞
  const renderVideoParameters = () => (
    <div className="space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="space-y-2">
          <Label>Êó∂Èïø (Áßí)</Label>
          <select
            value={parameters.duration || 5}
            onChange={(e) => setParameters({ ...parameters, duration: parseInt(e.target.value) })}
            className="w-full px-3 py-2 border rounded-md"
          >
            <option value={3}>3 Áßí</option>
            <option value={5}>5 Áßí</option>
            <option value={10}>10 Áßí</option>
            <option value={15}>15 Áßí</option>
          </select>
        </div>
        
        <div className="space-y-2">
          <Label>Â∏ßÁéá</Label>
          <select
            value={parameters.fps || 24}
            onChange={(e) => setParameters({ ...parameters, fps: parseInt(e.target.value) })}
            className="w-full px-3 py-2 border rounded-md"
          >
            <option value={12}>12 FPS</option>
            <option value={24}>24 FPS</option>
            <option value={30}>30 FPS</option>
            <option value={60}>60 FPS</option>
          </select>
        </div>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="space-y-2">
          <Label>ËøêÂä®Âº∫Â∫¶</Label>
          <select
            value={parameters.motion || 'medium'}
            onChange={(e) => setParameters({ ...parameters, motion: e.target.value })}
            className="w-full px-3 py-2 border rounded-md"
          >
            <option value="low">‰Ωé</option>
            <option value="medium">‰∏≠</option>
            <option value="high">È´ò</option>
            <option value="extreme">ÊûÅÈ´ò</option>
          </select>
        </div>
        
        <div className="space-y-2">
          <Label>ËΩ¨Âú∫ÊïàÊûú</Label>
          <select
            value={parameters.transition || 'none'}
            onChange={(e) => setParameters({ ...parameters, transition: e.target.value })}
            className="w-full px-3 py-2 border rounded-md"
          >
            <option value="none">Êó†</option>
            <option value="fade">Ê∑°ÂÖ•Ê∑°Âá∫</option>
            <option value="slide">ÊªëÂä®</option>
            <option value="zoom">Áº©Êîæ</option>
          </select>
        </div>
      </div>

      <div className="space-y-2">
        <Label>ÈïúÂ§¥ËßíÂ∫¶</Label>
        <select
          value={parameters.cameraAngle || 'eye-level'}
          onChange={(e) => setParameters({ ...parameters, cameraAngle: e.target.value })}
          className="w-full px-3 py-2 border rounded-md"
        >
          <option value="eye-level">Âπ≥ËßÜ</option>
          <option value="high-angle">‰øØËßÜ</option>
          <option value="low-angle">‰ª∞ËßÜ</option>
          <option value="dutch-angle">ÂÄæÊñú</option>
          <option value="bird-eye">È∏üÁû∞</option>
        </select>
      </div>
    </div>
  )

  // Ê∏≤ÊüìÈ´òÁ∫ßÂèÇÊï∞
  const renderAdvancedParameters = () => (
    <div className="space-y-4">
      <div className="space-y-2">
        <Label>ÁßçÂ≠êÂÄº (ÂèØÈÄâ)</Label>
        <Input
          type="number"
          value={parameters.seed || ''}
          onChange={(e) => setParameters({ 
            ...parameters, 
            seed: e.target.value ? parseInt(e.target.value) : undefined 
          })}
          placeholder="ÈöèÊú∫ÁßçÂ≠êÂÄºÔºåÁî®‰∫éÂ§çÁé∞ÁªìÊûú"
        />
      </div>

      <div className="space-y-2">
        <Label>Ë¥üÂêëÊèêÁ§∫ËØç</Label>
        <textarea
          value={parameters.negativePrompt || ''}
          onChange={(e) => setParameters({ ...parameters, negativePrompt: e.target.value })}
          placeholder="ÊèèËø∞‰∏çÂ∏åÊúõÂá∫Áé∞ÁöÑÂÜÖÂÆπ..."
          className="w-full px-3 py-2 border rounded-md h-20 resize-none"
        />
      </div>

      <div className="flex items-center space-x-2">
        <input
          type="checkbox"
          id="addWatermark"
          checked={parameters.addWatermark || false}
          onChange={(e) => setParameters({ ...parameters, addWatermark: e.target.checked })}
        />
        <Label htmlFor="addWatermark">Ê∑ªÂä†Ê∞¥Âç∞</Label>
      </div>
    </div>
  )

  return (
    <div className="space-y-6">
      <Card>
        <CardHeader>
          <CardTitle>Âü∫Á°ÄÈÖçÁΩÆ</CardTitle>
          <CardDescription>ÈÄâÊã©ÁîüÊàêÁ±ªÂûãÂíåÂü∫Êú¨ÂèÇÊï∞</CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          <div className="space-y-2">
            <Label>ÁîüÊàêÁ±ªÂûã</Label>
            <div className="flex gap-4">
              <button
                type="button"
                onClick={() => setTaskType('image')}
                className={`px-4 py-2 rounded-md border ${
                  taskType === 'image' 
                    ? 'bg-primary text-primary-foreground border-primary' 
                    : 'bg-background border-input'
                }`}
              >
                üé® ÂõæÁâáÁîüÊàê
              </button>
              <button
                type="button"
                onClick={() => setTaskType('video')}
                className={`px-4 py-2 rounded-md border ${
                  taskType === 'video' 
                    ? 'bg-primary text-primary-foreground border-primary' 
                    : 'bg-background border-input'
                }`}
              >
                üé¨ ËßÜÈ¢ëÁîüÊàê
              </button>
            </div>
          </div>

          <div className="space-y-2">
            <Label>ÊèêÁ§∫ËØçÈÖçÁΩÆ</Label>
            <VariableEditor
              initialPrompt={prompt}
              onPromptChange={setPrompt}
              onVariablesChange={setVariables}
              onValuesChange={setVariableValues}
            />
          </div>

          <div className="space-y-4">
            {/* Ë¥¶Âè∑ÈÄâÊã© */}
            <div className="space-y-2">
              <Label>‰ª£ÁêÜË¥¶Âè∑</Label>
              {loadingModels ? (
                <div className="flex items-center justify-center py-4 border rounded-md">
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-2"></div>
                  <span className="text-sm text-muted-foreground">Loading accounts...</span>
                </div>
              ) : (
                <>
                  <select
                    value={selectedAccountId || ''}
                    onChange={(e) => setSelectedAccountId(e.target.value || null)}
                    className="w-full px-3 py-2 border rounded-md"
                  >
                    <option value="">ÈÄâÊã©‰∏Ä‰∏™‰ª£ÁêÜË¥¶Âè∑</option>
                    {availableAccounts.map((account) => (
                      <option key={account.id} value={account.id}>
                        {account.name} ({proxyAccountManager.getProviderDisplayName(account.provider)})
                      </option>
                    ))}
                  </select>

                  {availableAccounts.length === 0 && (
                    <div className="text-sm text-muted-foreground">
                      No proxy accounts configured.{' '}
                      <a href="/settings/proxy-accounts" className="text-primary underline">
                        Configure accounts here
                      </a>
                    </div>
                  )}
                </>
              )}
            </div>

            {/* Ê®°ÂûãÈÄâÊã© */}
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <Label>AI Ê®°Âûã</Label>
                {selectedModel && (
                  <div className="flex items-center space-x-2">
                    {(() => {
                      const model = getAvailableModelsForType().find(m => m.id === selectedModel)
                      const status = getModelStatus(selectedModel)
                      return (
                        <>
                          <div className={`w-2 h-2 rounded-full ${status.color}`}></div>
                          <span className="text-xs text-muted-foreground">{status.description}</span>
                          {model?.isEvoLink && (
                            <Badge variant="secondary" className="text-xs">
                              üîó EvoLink.AI
                            </Badge>
                          )}
                        </>
                      )
                    })()}
                  </div>
                )}
              </div>

              {loadingModels || !selectedAccountId ? (
                <div className="flex items-center justify-center py-8 border rounded-md bg-muted/20">
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-2"></div>
                  <span className="text-sm text-muted-foreground">
                    {selectedAccountId ? 'Loading models...' : 'ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™‰ª£ÁêÜË¥¶Âè∑'}
                  </span>
                </div>
              ) : (
                <>
                  {getAvailableModelsForType().length === 0 ? (
                    <div className="text-center py-8 border rounded-md bg-muted/20">
                      <p className="text-sm text-muted-foreground mb-2">
                        Ê≠§Ë¥¶Âè∑ÊöÇÊú™ÈÖçÁΩÆ{taskType === 'image' ? 'ÂõæÁâá' : 'ËßÜÈ¢ë'}Ê®°Âûã
                      </p>
                      <a href="/settings/model-configs" className="text-primary underline text-sm">
                        ÂâçÂæÄÈÖçÁΩÆÊ®°Âûã ‚Üí
                      </a>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {Object.entries(getModelsByProvider()).map(([provider, models]) => {
                        const providerInfo = getProviderInfo(provider)
                        return (
                          <div key={provider} className="border rounded-lg p-4">
                            <div className="flex items-center mb-3">
                              <span className="text-lg mr-2">{providerInfo.icon}</span>
                              <h4 className={`font-medium ${providerInfo.color}`}>
                                {providerInfo.name}
                              </h4>
                              <Badge variant="outline" className="ml-2">
                                {models.length} ‰∏™Ê®°Âûã
                              </Badge>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                              {models.map((model) => (
                                <div
                                  key={model.id}
                                  className={`relative p-3 border rounded-lg cursor-pointer transition-all hover:border-primary/50 hover:shadow-sm ${
                                    selectedModel === model.id
                                      ? 'border-primary bg-primary/5'
                                      : 'border-border bg-background'
                                  }`}
                                  onClick={() => setSelectedModel(model.id)}
                                >
                                  <div className="flex items-start justify-between">
                                    <div className="flex-1 min-w-0">
                                      <div className="flex items-center space-x-2 mb-1">
                                        <h5 className="font-medium text-sm truncate">
                                          {model.name}
                                        </h5>
                                        {model.isEvoLink && (
                                          <Badge variant="secondary" className="text-xs px-1 py-0">
                                            üîó
                                          </Badge>
                                        )}
                                      </div>
                                      <div className="text-xs text-muted-foreground">
                                        ${model.cost?.toFixed(3) || '0.000'}/Ê¨°
                                      </div>
                                    </div>
                                    <div className="ml-2">
                                      <div className={`w-3 h-3 rounded-full border-2 ${
                                        selectedModel === model.id
                                          ? 'bg-primary border-primary'
                                          : 'border-muted-foreground'
                                      }`} />
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )
                      })}
                    </div>
                  )}
                </>
              )}
            </div>
          </div>
        </CardContent>
      </Card>

      {taskType === 'image' && (
        <Card>
          <CardHeader>
            <CardTitle>ÂõæÁâáÂèÇÊï∞</CardTitle>
            <CardDescription>ÈÖçÁΩÆÂõæÁâáÁîüÊàêÁöÑÂÖ∑‰ΩìÂèÇÊï∞</CardDescription>
          </CardHeader>
          <CardContent>
            {renderImageParameters()}
          </CardContent>
        </Card>
      )}

      {taskType === 'video' && (
        <Card>
          <CardHeader>
            <CardTitle>ËßÜÈ¢ëÂèÇÊï∞</CardTitle>
            <CardDescription>ÈÖçÁΩÆËßÜÈ¢ëÁîüÊàêÁöÑÂÖ∑‰ΩìÂèÇÊï∞</CardDescription>
          </CardHeader>
          <CardContent>
            {renderVideoParameters()}
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <CardTitle>È´òÁ∫ßÂèÇÊï∞</CardTitle>
          <CardDescription>ÂèØÈÄâÁöÑÈ´òÁ∫ßÈÖçÁΩÆÈÄâÈ°π</CardDescription>
        </CardHeader>
        <CardContent>
          {renderAdvancedParameters()}
        </CardContent>
      </Card>

      <Card>
        <CardContent className="pt-6">
          <div className="flex justify-between items-center mb-4">
            <span className="font-medium">È¢Ñ‰º∞ÊàêÊú¨</span>
            <div className="text-right">
              <div className="text-2xl font-bold text-primary">
                ${estimatedCost.toFixed(4)}
              </div>
              <p className="text-sm text-muted-foreground">
                Âü∫‰∫éÂΩìÂâçÂèÇÊï∞ÁöÑÈ¢Ñ‰º∞Ë¥πÁî®
              </p>
            </div>
          </div>
          
          <div className="flex gap-4">
              <Button
                onClick={() => onSubmit({
                  type: taskType,
                  prompt,
                  model: selectedModel,
                  parameters: {
                ...parameters,
                variables: variables,
                variableValues: variableValues
              }
                })}
              disabled={!prompt || !selectedModel}
              className="flex-1"
              >
                ÂºÄÂßãÁîüÊàê
              </Button>
              {onCancel && (
          <Button variant="outline" onClick={onCancel}>
          ÂèñÊ∂à
          </Button>
          )}
          </div>
        </CardContent>
      </Card>
    </div>
  )
}